---
import Chapter from "@/layouts/Chapter.astro";
import type { GetStaticPaths } from "astro";
import { getCollection, render } from "astro:content";
import { Breadcrumbs } from "astro-breadcrumbs";

export const getStaticPaths = (async () => {
  const fics = await getCollection("fics");
  const chapters = await getCollection("chapters", ({ id }) => {
    return fics.find(({ data }) => data.chapters?.some(chapter => chapter.id === id));
  });
  return chapters.map(chapter => ({
    params: { 
      ficId: chapter.id.split("/")[0],
      chapterId: chapter.id.split("/")[1],
    },
    props: { chapter },
  }));
}) satisfies GetStaticPaths;

const { ficId, chapterId } = Astro.params;
const { chapter } = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(chapter);

const chapters = await getCollection("chapters", ({ id }) => id.split("/")[0] === ficId);
const fic = await getCollection("fics", ({ id }) => id === ficId);
chapters.sort((a, b) => a.data.sortOrder - b.data.sortOrder);
const current = chapters.findIndex(chapter => chapter.id === `${ficId}/${chapterId}`);
const next = current + 1 === chapters.length ? undefined : chapters[current + 1];
const previous = current === 0 ? undefined : chapters[current - 1];
const lastModified = new Date(remarkPluginFrontmatter.lastModified);

const links = [
  { index: "last", text: chapter.data.title },
  { index: 2, text: fic[0].data.title },
];
---
<Chapter 
  title={chapter.data.title} 
  ficTitle={fic[0].data.title}
  date={chapter.data.publishedAt} 
  {lastModified} 
  notes={chapter.data.notes}
>
  {chapter.id}
  <Fragment slot="breadcrumbs">
    <Breadcrumbs id="breadcrumbs" customizeLinks={links} linkTextFormat="capitalized">
      <Fragment slot="separator" set:text="/" />
    </Breadcrumbs>
  </Fragment>

  <Content />
  {chapters.length > 1 && (
  <nav id="chapter-pagination" slot="pagination">
    <div id="chapter-index">
      <label for="chapter-select">Chapters:</label>
      <select name="chapter-select" id="chapter-select">
        {chapters.map(chapter => (
          <option 
            value={`/fics/${chapter.id}`} 
            selected={chapter.id.split("/")[1] === chapterId ? "selected" : undefined}
          >
            {chapter.data.title}
          </option>
        ))}
      </select>
    </div>
    {previous && <a id="previous" href={`/fics/${previous.id}`}>{previous.data.title}</a>}
    {next && <a id="next" href={`/fics/${next.id}`}>{next.data.title}</a>}
  </nav>
  )}
</Chapter>

<style>
  :global(#breadcrumbs) {
    ol {
      display: flex;
      gap: 0.5rem;
      list-style: none;
      padding: 0;

      li {
        display: flex;
        gap: 0.5rem;
      }

      .c-breadcrumbs__separator { opacity: 0.5; }
      a[aria-current="location"] {
        color: hsl(from var(--accent-color) h calc(s - 10) calc(l / 1.75));
        font-weight: bold;
      }
    }

    @media screen and (max-width: 600px) {
      font-size: calc(1rem - 1px);
    }
  }

  #chapter-pagination {
    display: grid;
    grid: 1fr auto / repeat(2, 1fr);
    gap: 0.5rem;

    #chapter-index {
      grid-area: 1 / 1 / 1 / -1;
      width: min-content;
      justify-self: center;
    }

    #chapter-select {
      background-color: var(--bg-color);
      color: var(--fg-color);
      border: 2px solid var(--fg-color);
      padding: 0.25rem 0.5rem;
      
      &:hover { background-color: hsl(from var(--bg-color) h s calc(l - 10)); }
    }

    #previous {
      grid-area: 2 / 1 / 2 / 1;
      justify-self: left;
    }

    #next {
      grid-area: 2 / 2 / 2 / 2;
      justify-self: right;
    }
  }
</style>

<script>
  const select: HTMLSelectElement | null = document.querySelector("#chapter-select");
  select?.addEventListener("change", (e) => {
    if (e.target instanceof HTMLSelectElement) {
      window.location.href = e.target.value;
    }
  });
</script>